/*
GPII Infusion/Express Middleware

Copyright 2012 OCAD University

Licensed under the New BSD license. You may not use this file except in
compliance with this License.

You may obtain a copy of the License at
https://github.com/gpii/universal/LICENSE.txt
*/

(function () {

    "use strict";

    var fluid = require("infusion"),
        fs = require("fs"),
        path = require("path"),
        gpii = fluid.registerNamespace("gpii");

    fluid.require("gpiiFramework", require);
    fluid.require("matchMaker", require);
    fluid.require("transformer", require);
    fluid.require("deviceReporter", require);
    fluid.require("lifecycleManager", require);
    fluid.require("lifecycleActions", require);
    fluid.require("flowManager", require);
    fluid.require("settingsHandlers", require);
    fluid.require("preferencesServer", require);
    fluid.require("solutionsRegistry", require);
    fluid.require("ontologyServer", require);

    fluid.registerNamespace("gpii.config")

    gpii.config.getNodeEnv = function () {
        return process.env.NODE_ENV || "development";
    };

    gpii.config.getConfigPath = function () {
        return fluid.get(process.argv, "2");
    };

    gpii.config.getBaseConfig = function (basePath) {
        var config = {};
        try {
            config = JSON.parse(fs.readFileSync(basePath));
        } finally {
            return config;
        }
    };

    gpii.config.mergeDemands = function (target, source) {
        target = fluid.makeArray(target);
        source = fluid.makeArray(source);
        return target.concat(source);
    };

    gpii.config.makeConfigLoader = function (options) {
        var fullPath = path.resolve(options.configPath, fluid.path(options.nodeEnv, "json")),
            basePath = path.resolve(options.configPath, "base.json"),
            baseConfig = gpii.config.getBaseConfig(basePath),
            config = fluid.merge({
                demands: gpii.config.mergeDemands
            }, baseConfig, JSON.parse(fs.readFileSync(fullPath))),
            componentName = config.typeName,
            demands = config.demands;
        fluid.each(demands, function (demand) {
            fluid.demands(demand.demandingName, demand.contextNames, demand.demandSpec);
        });
        fluid.defaults(componentName, config.options);
        return fluid.invokeGlobalFunction(componentName);
    };

})();