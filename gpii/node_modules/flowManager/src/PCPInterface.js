/**
* GPII PCP Render Handler
*
* Copyright 2014 Astea
* Copyright 2015 Raising the Floor - International
*
* Licensed under the New BSD license. You may not use this file except in
* compliance with this License.
*
* You may obtain a copy of the License at
* https://github.com/gpii/universal/LICENSE.txt
*/
(function () {
    "use strict";

    var fluid = require("infusion");
    var gpii = fluid.registerNamespace("gpii");

    fluid.registerNamespace("gpii.request.flowManager");
    fluid.registerNamespace("gpii.pcpInterface");

    fluid.defaults("gpii.pcpInterface", {
        gradeNames: ["autoInit", "fluid.eventedComponent"],
        members: {
            socket: null
        },
        invokers: {
            sendUserMessage: {
                funcName: "gpii.pcpInterface.sendUserMessage",
                args: ["{that}.socket", "{arguments}.0" ]
            },
            notifyLogin: {
                funcName: "gpii.pcpInterface.notifyLogin",
                args: ["{that}.socket", "{arguments}.0", "{arguments}.1" ]
                                        // user token, adjusters
            },
            notifyLogout: {
                funcName: "gpii.pcpInterface.notifyLogout",
                args: ["{that}.socket" ]
            },
            initSocket: {
                funcName: "gpii.pcpInterface.initSocket",
                args: ["{that}", "{arguments}.0" ] // socket connection
            }
        },
        events: {
            sendUserMessage: null
        },
        listeners: {
            sendUserMessage: "{that}.sendUserMessage"
        }
    });

    gpii.pcpInterface.initSocket = function (that, socket) {
        that.socket = socket;
    };

    gpii.pcpInterface.sendUserMessage = function (socket, message) {
        if (socket === null) {
            fluid.log("No PCP connected, so discarding message: " + message);
            return;
        }
        socket.emit("message", message, fluid.log);
    };

    /**
     * Adjusters can be passed to the PCP via the adjusters argument. If
     * this is left empty, a ddefault set of adjusters will be passed to
     * the PCP.
     */
    gpii.pcpInterface.notifyLogin = function (socket, userToken, adjusters) {
        if (socket === null) {
            fluid.log("No PCP connected, so is not attempting to notify of a loging");
            return;
        }
        var defaultAdjusters = {
            "http://registry.gpii.net/common/highContrastEnabled": false
        };
        socket.emit("login", {
            settings: adjusters !== undefined ? adjusters : defaultAdjusters,
            userToken: userToken
        });
    };

    gpii.pcpInterface.notifyLogout = function (socket) {
        if (socket === null) {
            fluid.log("No PCP connected, so is not attempting to notify of a log out");
            return;
        }
        socket.emit("logout");
    };

    fluid.defaults("kettle.requests.request.handler.pcpChannel", {
        gradeNames: ["gpii.request.flowManager.sessionAware", "autoInit"],
        invokers: {
            handle: {
                funcName: "gpii.request.flowManager.pcpChannelHandle",
                args: ["{that}", "{request}.socket", "{requestProxy}.events", "{flowManager}.pcpInterface" ],
                dynamic: true
            }
        }
    });

    gpii.request.flowManager.pcpChannelHandle = function (that, socket, events, pcpInterface) {
        pcpInterface.initSocket(socket);
        events.onSuccess.fire("Client has successfully established connection to the PCP Channel");
    };
})();