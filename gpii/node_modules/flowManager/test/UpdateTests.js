/**
 * GPII Flow Manager Update Tests
 *
 * Copyright 2013 OCAD University
 *
 * Licensed under the New BSD license. You may not use this file except in
 * compliance with this License.
 *
 * You may obtain a copy of the License at
 * https://github.com/GPII/kettle/LICENSE.txt
 */

/*global require, __dirname*/

var fluid = require("infusion"),
    path = require("path"),
    flowManager = fluid.require("flowManager", require),
    jqUnit = fluid.require("jqUnit"),
    configPath = path.resolve(__dirname, "./configs"),
    kettle = fluid.registerNamespace("kettle"),
    fs = require("fs"),
    $ = fluid.registerNamespace("jQuery");

fluid.require("kettle/test/utils/js/KettleTestUtils", require);

var update = fluid.registerNamespace("kettle.tests.flowManagerUpdate");

update.tokenNisha = "nisha";

update.tokenNishDefaulPrefs = require(path.resolve(__dirname,
    "../../../../testData/preferences/nisha.json"));

update.tokenNishaPrefs = $.extend(true, {}, update.tokenNishDefaulPrefs, {
    "http://registry.gpii.org/common/fontSize": [{ value: 14 }]
});

update.tokenNishaPrefsUpdate = {
    success: true
};

update.tokenNishaPrefsUpdated = $.extend(true, {}, update.tokenNishDefaulPrefs, {
    "http://registry.gpii.org/common/fontSize": [{ value: 16 }]
});

update.testLoginResponse = function (data, headers, cookies, signedCookies) {
    jqUnit.assertEquals("Response is correct", "User with token " +
        update.tokenNisha + " was successfully logged in.", data);
    jqUnit.assertValue("Cookie is set", headers["set-cookie"]);
    jqUnit.assertTrue("kettle session cookie is set", !!signedCookies["kettle.sid"]);
};

update.testLogoutResponse = function (data, headers, cookies) {
    jqUnit.assertEquals("Response is correct", "User with token " +
        update.tokenNisha + " was successfully logged out.", data);
    jqUnit.assertEquals("kettle session cookie is unset", "", cookies["kettle.sid"]);
};

update.testInvalidUpdateRequest = function (reason) {
    jqUnit.assertTrue("Authorization failed as expected", true);
};

update.testFirstUpdateRequest = function (data) {
    testUpdateRequest(update.tokenNishaPrefsUpdate, data)
};

update.testSecondUpdateRequest = function (data) {
    testUpdateRequest(update.tokenNishaPrefsUpdate, data)
};

function jqUnitCondition (args, activity) {
    if (QUnit.config.current) {
        QUnit.ok(false, "Assertion failure (see console.log for expanded message): ".concat(args));
    }
    fluid.builtinFail(false, args, activity);
}

function utilsCondition (args, activity) {
    var messages = args.concat(activity),
        request = fluid.expand("{request}", {
            fetcher: fluid.makeEnvironmentFetcher()
        });
    if (!request) {
        messages = ["ASSERTION FAILED: "].concat(messages);
        console.log.apply(null, messages);
        throw new Error(args[0]);
    }
    request.events.onError.fire({
        isError: true,
        message: messages.join("")
    });
}

function setErrorHandling (useUtils) {
    fluid.pushSoftFailure(-1);
    fluid.pushSoftFailure(useUtils ? utilsCondition : jqUnitCondition);
};

update.clearActiveSessions = function (activeSessions) {
    delete activeSessions.nisha;
    setErrorHandling(true);
};

update.testUpdateRequestFailure = function (data) {
    jqUnit.assertTrue("Received error as expected", data.isError);
    jqUnit.assertTrue("Message is correct",
        data.message.indexOf("User with token nisha has no active session") > -1);
    setErrorHandling();
};

function testUpdateRequest(expected, data) {
    jqUnit.assertDeepEq("Response is correct", expected, data);
}

var testDefs = [{
    name: "Flow Manager update tests.",
    expect: 13,
    config: {
        nodeEnv: "update",
        configPath: configPath
    },
    components: {
        invalidUpdateRequest: {
            type: "kettle.tests.request.io",
            options: {
                requestOptions: {
                    path: "/update"
                }
            }
        },
        login: {
            type: "kettle.tests.request.http",
            options: {
                requestOptions: {
                    path: "/user/%token/login"
                },
                termMap: {
                    token: update.tokenNisha
                }
            }
        },
        logout: {
            type: "kettle.tests.request.http",
            options: {
                requestOptions: {
                    path: "/user/%token/logout"
                },
                termMap: {
                    token: update.tokenNisha
                }
            }
        },
        updateRequest: {
            type: "kettle.tests.request.io",
            options: {
                requestOptions: {
                    path: "/update"
                }
            }
        }
    },
    sequence: [{
        func: "{invalidUpdateRequest}.send",
        args: "You shall not pass!!"
    }, {
        event: "{invalidUpdateRequest}.events.onError",
        listener: "kettle.tests.flowManagerUpdate.testInvalidUpdateRequest"
    }, {
        func: "{login}.send"
    }, {
        event: "{login}.events.onComplete",
        listener: "kettle.tests.flowManagerUpdate.testLoginResponse"
    }, {
        func: "{updateRequest}.send",
        args: update.tokenNishaPrefs
    }, {
        event: "{updateRequest}.events.onComplete",
        listener: "kettle.tests.flowManagerUpdate.testFirstUpdateRequest"
    }, {
        func: "{updateRequest}.send",
        args: update.tokenNishaPrefsUpdated
    }, {
        event: "{updateRequest}.events.onComplete",
        listener: "kettle.tests.flowManagerUpdate.testSecondUpdateRequest"
    }, {
        func: "{logout}.send"
    }, {
        event: "{logout}.events.onComplete",
        listener: "kettle.tests.flowManagerUpdate.testLogoutResponse"
    }, {
        func: "{login}.send"
    }, {
        event: "{login}.events.onComplete",
        listener: "kettle.tests.flowManagerUpdate.testLoginResponse"
    }, {
        func: "kettle.tests.flowManagerUpdate.clearActiveSessions",
        args: "{tests}.configuration.server.lifecycleManager.activeSessions"
    }, {
        func: "{updateRequest}.send",
        args: update.tokenNishaPrefs
    }, {
        event: "{updateRequest}.events.onComplete",
        listener: "kettle.tests.flowManagerUpdate.testUpdateRequestFailure"
    }]
}];

module.exports = kettle.tests.bootstrap(testDefs);
