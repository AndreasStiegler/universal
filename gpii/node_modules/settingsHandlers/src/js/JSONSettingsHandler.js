/*!
GPII JSON Settings Handler

Copyright 2012 OpenDirective and Raising the Floor - International

Licensed under the New BSD license. You may not use this file except in
compliance with this License.

You may obtain a copy of the License at
https://github.com/gpii/universal/LICENSE.txt
*/

(function () {
    var fluid = require("infusion"),
        fs = require("fs"),
        gpii = fluid.registerNamespace("gpii");

    fluid.registerNamespace("gpii.settingsHandlers.JSONSettingsHandler");

    gpii.settingsHandlers.JSONSettingsHandler.set = function(payload) {
	var app = fluid.copy(payload); 
	for (var appId in app) {
	    for (var j = 0; j < app[appId].length; j++) { 
                var path = app[appId][j].options.path; 
		var jsonFile = require(path);
		var settings = app[appId][j].settings;
		var response = fluid.copy(settings);
		for (var settingKey in settings) {
		    var oldValue = jsonFile[settingKey];
		    var newValue = settings[settingKey];
		    response[settingKey] = {
			"oldValue": oldValue,
			"newValue": newValue
		    };
		}
		fluid.merge(null, jsonFile,  settings);    
		fs.writeFile(path, JSON.stringify(jsonFile));
		app[appId][j] = response;
	    } 
	}
	console.log(app);
	return app;
    }

}());
