/*!
GPII JSON Settings Handler

Copyright 2012 OpenDirective and Raising the Floor - International

Licensed under the New BSD license. You may not use this file except in
compliance with this License.

You may obtain a copy of the License at
https://github.com/gpii/universal/LICENSE.txt
*/

/*global require */
(function () {
    var fluid = require("infusion"),
        fs = require("fs"),
        gpii = fluid.registerNamespace("gpii");

    fluid.registerNamespace("gpii.settingsHandlers.JSONSettingsHandler");

//    var pathToSettingsFile = "c:/Users/rgardler/projects/maavis/media/Users/";
//    var payload = require("c:/Users/rgardler/projects/gpii/node_modules/universal/gpii/node_modules/settingsHandlers/test/data/JSONSettingsHandler/testPayload.json");

 gpii.settingsHandlers.JSONSettingsHandler.set = function(payload) {
     console.log("Hi from settings handler");
     var app = fluid.copy(payload); 
     for (var appId in app) {
	 for (var j = 0; j < app[appId].length; j++) { 
             var path = app[appId][j].options.path; 
             var jsonFile = require(path);
             var settings = app[appId][j].settings;
	     var response = fluid.copy(settings);
	     for (var settingKey in settings) {
		 var oldValue = jsonFile[settingKey];
		 var newValue = settings[settingKey];
		 response[settingKey] = {
		     "oldValue": oldValue,
		     "newValue": newValue
		 };
	     }
	     fluid.merge(null, jsonFile,  settings);    
	     fs.writeFile(path, JSON.stringify(jsonFile));
	     app[appId][j] = response;
	 } 
     }
     console.log(app);
     return app;
 }

// gpii.settingsHandlers.JSONHandler.set(payload);

}());
