/*!
  GPII Web Sockets Settings Handler

  Copyright 2014, 2015 Emergya

  Licensed under the New BSD license. You may not use this file except in
  compliance with this License.

  You may obtain a copy of the License at
  https://github.com/gpii/universal/LICENSE.txt
*/

/*global require*/

(function () {

    "use strict";

    var fluid = require("infusion"),
        gpii = fluid.registerNamespace("gpii"),
        $ = fluid.registerNamespace("jQuery");

    fluid.defaults("gpii.settingsHandlers.WebSocketsComponent", {
        gradeNames: ["fluid.modelRelayComponent", "autoInit"],
        changeApplierOptions: {
            resolverGetConfig: fluid.model.escapedGetConfig,
            resolverSetConfig: fluid.model.escapedSetConfig
        },
        clients: {},
        model: {
            settings: {}
        },
        modelListeners: {
            "settings.*": {
                funcName: "gpii.settingsHandlers.WebSocketsComponent.settingsChanged",
                args: "{change}"
            }
        },
        invokers: {
            addClient: {
                funcName: "gpii.settingsHandlers.WebSocketsComponent.addClient",
                args: ["{that}", "{arguments}.0", "{arguments}.1"]
            },
            removeClient: {
                funcName: "gpii.settingsHandlers.WebSocketsComponent.removeClient",
                args: ["{that}", "{arguments}.0"]
            },
            getSettingsForId: {
                funcName: "gpii.settingsHandlers.WebSocketsComponent.getSettingsForId",
                args: ["{that}", "{arguments}.0"]
            },
            setSettingsForId: {
                funcName: "gpii.settingsHandlers.WebSocketsComponent.setSettingsForId",
                args: ["{that}", "{arguments}.0", "{arguments}.1"]
            },
            get: {
                funcName: "gpii.settingsHandlers.WebSocketsComponent.get",
                args: ["{arguments}.0", "{that}"]
            },
            set: {
                funcName: "gpii.settingsHandlers.WebSocketsComponent.set",
                args: ["{arguments}.0", "{that}"]
            }
        }
    });

    ///////////////// Clients /////////////////////

    gpii.settingsHandlers.WebSocketsComponent.addClient = function (that, solutionId, client) {
        var currentValue = fluid.get(that.options.clients, [solutionId, client.id]);
        if (!currentValue) {
            fluid.set(that.options.clients, [solutionId, client.id], client);
        }
    };

    gpii.settingsHandlers.WebSocketsComponent.removeClient = function (that, client) {
        for (var solutionId in that.options.clients) {
            delete that.options.clients[solutionId][client.id];
            if ($.isEmptyObject(that.options.clients[solutionId])) {
                delete that.options.clients[solutionId];
            }
        }
    };

    ///////////////// Settings /////////////////////

    gpii.settingsHandlers.WebSocketsComponent.settingsChanged = function (/*change*/) {
        //console.log("A change in settings has been registered: " + JSON.stringify(a, null, 2));
    };

    gpii.settingsHandlers.WebSocketsComponent.getSettingsForId = function (that, solutionId) {
        return fluid.get(that.model.settings, [solutionId]);
    };

    gpii.settingsHandlers.WebSocketsComponent.setSettingsForId = function (that, solutionId, settings) {
        var type;

        if (settings === undefined) {
            type = "DELETE";
        } else {
            type = fluid.get(that.model.settings, solutionId) === undefined ? "ADD": null;
        }

        that.applier.change(["settings", solutionId], settings, type);
    };

    gpii.settingsHandlers.WebSocketsComponent.getSettings = function (payload, solutionId, that) {
        var currentSettings = fluid.get(that.model.settings, [solutionId]);

        var results = [];

        for (var i=0; i< payload.length; i++) {
            /*jshint -W083 */
            results[i] = {settings: {}};
            results[i].settings = fluid.transform(payload[i].settings, function (value, key) {
                var currentValue = fluid.get(currentSettings, key);
                return currentValue;
            });
        }

        return results;
    };

    gpii.settingsHandlers.WebSocketsComponent.get = function (payload, that) {
        var result = fluid.copy(payload);

        for (var appId in payload) {
            if (appId in that.model.settings) {
                result[appId] = gpii.settingsHandlers.WebSocketsComponent.getSettings(payload[appId], appId, that);
            }
        }
        return result;
    };

    gpii.settingsHandlers.WebSocketsComponent.setSettingsIndividually = function (payload, solutionId, that) {
        var results = {settings: {}};

        fluid.each(payload.settings, function (value, key) {
            var currentValue = fluid.get(that.model.settings, [solutionId, key]);

            var type;
            if (currentValue === undefined) {
                type = "ADD";
            } else if (value === undefined) {
                type = "DELETE";
            } else {
                type = null;
            }

            results.settings[key] = {
                oldValue: currentValue,
                newValue: value
            };

            that.applier.change(["settings", solutionId, key], value, type);
        });

        // Is there any other way to check this?
        //
        if ($.isEmptyObject(that.model.settings[solutionId])) {
            delete that.model.settings[solutionId];
        }

        return results;
    };

    gpii.settingsHandlers.WebSocketsComponent.setSettings = function (payload, solutionId, that) {
        var results = [];

        for (var i=0; i< payload.length; i++) {
            results[i] = gpii.settingsHandlers.WebSocketsComponent.setSettingsIndividually(payload[i], solutionId, that);
            gpii.settingsHandlers.WebSocketsComponent.notifySettings(solutionId, that);
        }

        return results;
    };

    gpii.settingsHandlers.WebSocketsComponent.set = function (payload, that) {
        var result = fluid.copy(payload);

        for (var appId in payload) {
            result[appId] = gpii.settingsHandlers.WebSocketsComponent.setSettings(payload[appId], appId, that);
        }

        return result;
    };

    gpii.settingsHandlers.WebSocketsComponent.notifySettings = function(id, that) {
        if (id in that.options.clients) {
            var newSettings = gpii.settingsHandlers.WebSocketsComponent.getSettingsForId(that, id);
            for (var client in that.options.clients[id]) {
                that.options.clients[id][client].emit("onBrowserSettingsChanged", newSettings);
            }
        }
    };

})();

